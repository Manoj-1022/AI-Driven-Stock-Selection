<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AI Stocks</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">

  <style>
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.65);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      backdrop-filter: blur(3px);
    }

    .loading-box {
      background: #0f0f0f;
      border-radius: 14px;
      padding: 24px 32px;
      text-align: center;
      border: 1px solid #333;

      box-shadow:
        0 0 20px rgba(0, 0, 0, 0.7),
        0 0 35px rgba(0, 255, 100, 0.05);
    }

    .loading-box p {
      margin: 12px 0 0;
      color: #e8e8e8;
      font-size: 1rem;
      font-weight: 400;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #27b52c;
      animation: spin 0.8s linear infinite;
      margin: 0 auto;

      box-shadow:
        0 0 10px #45c64a,
        0 0 25px #45c64a,
        0 0 45px #45c64a,
        0 0 60px #45c64a;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: not-allowed !important;
    }
  </style>

</head>

<body>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-box">
      <div class="spinner"></div>
      <p>Training model on historical data.It takes a little bit of time... </p>

    </div>
  </div>

  <header class="site-header">
    <div class="header-inner">
      <div class="header-left">
        <img class="header-logo" src="/static/images/Logo.png" alt="logo">
        <h1 class="header-title">AI-Driven Stock Selection & Optimization</h1>
      </div>

      <div class="header-actions">
        <button id="takeTestBtn" class="header-btn quiz-btn" type="button"> Quiz</button>
        <a id="portfolioBtn" class="header-btn portfolio-btn" href="/portfolio"> Portfolio Allocation</a>
        <a id="tradebtn" class="header-btn trade-btn" href="/trade-calculator">Trade Calculator</a>
      </div>
    </div>
  </header>

  <main class="main-wrap">

    <div class="container">
      <h1>Stock Research</h1>
      <p class="subtitle">Enter symbol (e.g., RELIANCE.NS )</p>

      <form id="searchForm">
        <input id="stock" name="stock" type="text" placeholder="Enter stock symbol" required>
        <button type="submit" id="predictBtn">üîç Predict</button>
      </form>

      <div id="results" class="results" style="display:none;">
        <h2 id="stockTitle"></h2>

        <div id="warnings" class="box"></div>
        <div id="fundamentals" class="table-section"></div>

        <div class="graph-section">
          <h3>üìà Past Performance</h3>
          <img id="pastGraph" class="graph" alt="Past graph" style="display:none;">
          <br>
          <button id="downloadPast" class="download-btn">‚¨áÔ∏è Download Past Graph</button>

          <h3>üîÆ 2-Year Prediction</h3>
          <img id="futureGraph" class="graph" alt="Future graph" style="display:none;">
          <br>
          <button id="downloadFuture" class="download-btn">‚¨áÔ∏è Download Prediction Graph</button>

          <h3>üìè Actual vs Predicted Price</h3>
          <img id="accuracyGraph" class="graph" alt="Accuracy graph" style="display:none;">
          <br>
          <button id="downloadAccuracy" class="download-btn">‚¨áÔ∏è Download Accuracy Graph</button>
        </div>
      </div>
    </div>

    <section class="learn-section" style="max-width:980px;margin:28px auto;">
      <h3 id="learnToggle" class="toggle-header" style="cursor:pointer;">
        üìò Learn About Stock Market ‚¨áÔ∏è
      </h3>

      <div id="learnContent" class="learn-content" style="display:none;">
        <p>Download these free resources to understand market concepts:</p>

        <ul class="pdf-list">
          <li><a href="{{ url_for('static', filename='pdfs/investing_basics.pdf') }}" download>üìÑ Investing Basics</a>
          </li>
          <li><a href="{{ url_for('static', filename='pdfs/technical_analysis.pdf') }}" download>üìÑ Technical
              Analysis</a></li>
          <li><a href="{{ url_for('static', filename='pdfs/fundamentals.pdf') }}" download>üìÑ Fundamental Analysis</a>
          </li>
        </ul>
      </div>
    </section>

  </main>

  <footer class="site-footer site-footer-fixed" role="contentinfo">
    <div class="footer-inner">
      <div class="footer-disclaimer">
        <strong>Disclaimer:</strong>
        <div class="disclaimer-text">
          This website is for informational and educational purposes only.<br>
          Predictions are generated using AI based on historical data.<br>
          No forecast is guaranteed. This is not financial advice.<br>
        </div>
      </div>
    </div>
  </footer>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const takeTestBtn = document.getElementById('takeTestBtn');
      if (takeTestBtn) {
        takeTestBtn.addEventListener('click', () => {
          const w = window.open('/test', '_blank');
          if (!w) window.location.href = '/test';
        });
      }

      const learnToggle = document.getElementById('learnToggle');
      const learnContent = document.getElementById('learnContent');

      if (learnToggle && learnContent) {
        learnContent.style.display = 'none';

        learnToggle.addEventListener('click', () => {
          if (learnContent.style.display === 'none' || !learnContent.style.display) {
            learnContent.style.display = 'block';
            learnToggle.innerText = 'üìò Learn About Stock Market ‚¨ÜÔ∏è';
          } else {
            learnContent.style.display = 'none';
            learnToggle.innerText = 'üìò Learn About Stock Market ‚¨áÔ∏è';
          }
        });
      }

      const loadingOverlay = document.getElementById('loadingOverlay');
      const predictBtn = document.getElementById('predictBtn');
      const stockInput = document.getElementById('stock');

      const setLoading = (isLoading) => {
        if (loadingOverlay) {
          loadingOverlay.style.display = isLoading ? 'flex' : 'none';
        }
        if (predictBtn) {
          predictBtn.disabled = isLoading;
          predictBtn.classList.toggle('btn-disabled', isLoading);
          predictBtn.textContent = isLoading ? '‚è≥ Training...' : 'üîç Predict';
        }
        if (stockInput) {
          stockInput.disabled = isLoading;
        }
      };

      const form = document.getElementById('searchForm');
      if (form) {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();

          const stock = (document.getElementById('stock') || {}).value || '';
          if (!stock.trim()) {
            alert('Enter symbol');
            return;
          }

          const resultsEl = document.getElementById('results');
          const stockTitle = document.getElementById('stockTitle');
          const warnings = document.getElementById('warnings');
          const fundamentals = document.getElementById('fundamentals');

          if (resultsEl) resultsEl.style.display = 'none';
          if (stockTitle) stockTitle.textContent = '';
          if (warnings) warnings.innerHTML = '';
          if (fundamentals) fundamentals.innerHTML = '';

          ['pastGraph', 'futureGraph', 'accuracyGraph'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
              el.style.display = 'none';
              el.src = '';
            }
          });

          setLoading(true);

          try {
            const resp = await fetch('/predict', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: `stock=${encodeURIComponent(stock)}`
            });

            let data;
            try {
              data = await resp.json();
            } catch (parseErr) {
              console.error('JSON parse error', parseErr);
              alert('Server returned invalid JSON.');
              setLoading(false);
              return;
            }

            if (data.error) {
              if (stockTitle) {
                const msg = String(data.error).split('\n')[0];
                stockTitle.innerHTML = `<span style="color:#ff6b6b">${msg}</span>`;
              }
              if (resultsEl) resultsEl.style.display = 'block';
              setLoading(false);
              return;
            }

            if (stockTitle) stockTitle.textContent = data.stock || stock;

            if (warnings) {
              warnings.innerHTML = data.warnings && data.warnings.length
                ? `<pre>${data.warnings.join('\n')}</pre>`
                : `<pre class="success">No major warnings</pre>`;
            }

            if (fundamentals) {
              let html = '<table><tr><th>Metric</th><th>Value</th></tr>';
              Object.entries(data.fundamentals || {}).forEach(([k, v]) => {
                html += `<tr><td>${k}</td><td>${v}</td></tr>`;
              });
              html += '</table>';
              fundamentals.innerHTML = html;
            }

            if (data.past_chart) {
              const pg = document.getElementById('pastGraph');
              if (pg) {
                pg.src = 'data:image/png;base64,' + data.past_chart;
                pg.style.display = 'block';
              }
            }

            if (data.future_chart) {
              const fg = document.getElementById('futureGraph');
              if (fg) {
                fg.src = 'data:image/png;base64,' + data.future_chart;
                fg.style.display = 'block';
              }
            }

            if (data.accuracy_chart) {
              const ag = document.getElementById('accuracyGraph');
              if (ag) {
                ag.src = 'data:image/png;base64,' + data.accuracy_chart;
                ag.style.display = 'block';
              }
            }

            if (resultsEl) resultsEl.style.display = 'block';

          } catch (err) {
            console.error('Predict error', err);
            alert('Prediction failed: network error. Check console.');
          } finally {
            setLoading(false);
          }
        });
      }

      const setupDownload = (btnId, imgId, filename) => {
        const btn = document.getElementById(btnId);
        if (!btn) return;

        btn.addEventListener('click', function () {
          const img = document.getElementById(imgId);
          if (!img || !img.src || img.style.display === 'none') {
            alert('‚ö† No ' + (filename || 'image') + ' available to download.');
            return;
          }

          const link = document.createElement('a');
          link.href = img.src;
          link.download = filename;
          link.click();
        });
      };

      setupDownload('downloadPast', 'pastGraph', 'past_performance.png');
      setupDownload('downloadFuture', 'futureGraph', 'future_prediction.png');
      setupDownload('downloadAccuracy', 'accuracyGraph', 'accuracy_graph.png');

      ['pastGraph', 'futureGraph', 'accuracyGraph'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
      });
    });
  </script>

</body>

</html>